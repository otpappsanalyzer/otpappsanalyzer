import requests
import json
import timeit
import time
import os
import os.path
import sqlite3
from requests_toolbelt.multipart.encoder import MultipartEncoder
import csv
import pandas as pd


def upload_apk(FILE):
    print("Uploading file")
    multipart_data = MultipartEncoder(fields={'file': (FILE, open(FILE, 'rb'), 'application/octet-stream')})
    headers = {'Content-Type': multipart_data.content_type, 'Authorization': APIKEY}
    response = requests.post(SERVER + '/api/v1/upload', data=multipart_data, headers=headers)
    return response.content

def scan_apk(data):
    print("Scanning file")
    post_dict = json.loads(data)
    headers = {'Authorization': APIKEY}
    response = requests.post(SERVER + '/api/v1/scan', data=post_dict, headers=headers)
    return response.content

def json_resp(data):
    print("Generate JSON report")
    headers = {'Authorization': APIKEY}
    data = {"hash": json.loads(data)["hash"]}
    response = requests.post(SERVER + '/api/v1/report_json', data=data, headers=headers)
    return response.content

def delete(data):
    """Delete Scan Result"""
    print("Deleting Scan")
    headers = {'Authorization': APIKEY}
    data = {"hash": json.loads(data)["hash"]}
    response = requests.post(SERVER + '/api/v1/delete_scan', data=data, headers=headers)
    print(response.text)


SERVER = "http://127.0.0.1:8000"
APIKEY = '0e714b825e40876307cb27e0e48d0daf3606209d3d5aba53c39fdf6b16260a37'

result_path = '/home/budi/OTP_project/OTP_code/mobsf_analysis/mobsf_result/'
malware_path = '/home/budi/OTP_project/OTP_code/malware_analysis/'
app_to_analyze = malware_path+'app_to_analyze.csv'


with open(app_to_analyze,'r') as fl:
    csv_reader = csv.reader(fl)
    next(csv_reader)
    for line in csv_reader:
        file = line[1]
        file_upload = line[0]
        res_upload = upload_apk(file_upload)
        scan_apk(res_upload)
  
        # access API for json report
        json_path = result_path+file.strip('\n')
        print(json_path)
        json_res = json_resp(res_upload)
        to_dict = json.loads(json_res)
        with open (json_path,'w+') as jp:
            json.dump(to_dict,jp) 
    
        print(file + '-->saved')
        time.sleep(15)
