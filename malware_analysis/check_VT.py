import os
import json
import pandas as pd

apps_path =  '/home/budi/OTP_project/apk_list/'
oversize_path = '/home/budi/OTP_project/OTP_code/malware_analysis/'
result_path = '/home/budi/OTP_project/OTP_code/mobsf_analysis/mobsf_result/'
split_apk_path = '/home/budi/OTP_project/OTP_code/mobsf_analysis/split_apk_list.txt'


"""Check split apk"""
###### Note : original split apk list file is in .json
split_list=[]
with open(split_apk_path,'r') as split:
    for item in split:
        split_list.append(item.strip('\n'))

# print(str(split_list))
"""Check oversize file"""
########Note : the list is .apk
oversize_dict=[]
oversize_vector=[]
for root,dirs,files in os.walk(apps_path):
    for file in files:
        check_file = apps_path+file
        file_size = os.path.getsize(check_file)
        if file_size >=  32000000:
            norm_size= round(file_size/1000000,1)
            item_list = {'file_name':file,'file_size':norm_size} # change the file into +.json
            oversize_dict.append(item_list)
            oversize_vector.append(file+'.json')

df_size = pd.DataFrame(oversize_dict)  
csv_file = oversize_path+'oversize_file_.csv'
df_size.to_csv(csv_file,index=False)
# print(str(oversize_vector))

app_to_analyze=[]
for root,dirs,files in os.walk(result_path):
    for file in files:
        # print(file)
        if file not in split_list and file not in oversize_vector:         
            res_file_path = root+file
            app_file_path = apps_path+file.rstrip('.json')
            with open (res_file_path,'r') as fp:
                try:
                    data = fp.read()
                    json_data = json.loads(data)
                    json_VT = json_data['virus_total']
                    if json_VT is None or 'Scan not performed' in str(json_VT) or 'Scan request successfully queued' in str(json_VT):
                        item_list = {'path':app_file_path,'file':file}
                        print(item_list)
                        app_to_analyze.append(item_list)
                        print(len(app_to_analyze))
                except:
                    print('virus total error --------------------------------'+file)
                    item_list = {'path':app_file_path,'file':file}
                    app_to_analyze.append(item_list)
                    pass


app_to_analyze_path = oversize_path+'app_to_analyze.csv'
df_to_analyze = pd.DataFrame(app_to_analyze)
df_to_analyze.to_csv(app_to_analyze_path,index=False)